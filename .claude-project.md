# Bible Trivia Game Project

## Overview
React Native trivia game with Supabase backend featuring a complete dev/prod environment system for safe content development, review, and migration.

### ğŸ“… Last Updated: December 15, 2025

**Recent Additions:**
- âœ… Environment switcher UI in HomeScreen
- âœ… QuestionCreateScreen for manual question creation
- âœ… BatchReviewScreen with card-based review workflow
- âœ… QuestionStatsScreen with quality metrics and migration readiness
- âœ… Edit Question UI (fully implemented with modal, validation, and success feedback)
- âœ… Role-based access control (dev tools hidden from non-admins)
- âœ… Real Supabase authentication (no longer mock auth)
- ğŸ§ª **TESTING GAPS**: Core services, integration tests, security tests

## Key Technologies
- **Frontend**: React Native + TypeScript + Expo
- **Backend**: Supabase (PostgreSQL database)
- **Navigation**: React Navigation (Native Stack)
- **State Management**: React Context API
- **Storage**: AsyncStorage
- **Environment System**: Dual dev/prod table architecture

## Current Project Status

### âœ… Completed Features

**Authentication System:**
- âœ… Complete auth flow (signup/login/logout) with real Supabase authentication
- âœ… AuthContext integrated with Supabase auth service
- âœ… Session management via Supabase (no longer mock auth)
- âœ… Protected routes
- âœ… User profiles auto-created via database trigger
- âœ… Comprehensive test suite

**Core Game Features:**
- âœ… 4 difficulty levels (Beginner, Intermediate, Expert, Scholar)
- âœ… Variable question counts per difficulty (10/15/20/25)
- âœ… 30-second timer per question
- âœ… Real-time score tracking
- âœ… Answer feedback with correct/incorrect highlighting
- âœ… Bible references and explanations display
- âœ… Game results screen with percentage scoring

**Screens:**
- âœ… LoginScreen - Authentication
- âœ… HomeScreen - Main menu with environment switcher and role-based dev tools
- âœ… DifficultyScreen - Difficulty selection
- âœ… GameScreen - Gameplay with timer and scoring
- âœ… ResultsScreen - Game results
- âœ… QuestionReviewScreen - Question management and review
- âœ… QuestionCreateScreen - Manual question creation UI
- âœ… BatchReviewScreen - Card-based batch review workflow
- âœ… QuestionStatsScreen - Statistics and quality metrics

**Components:**
- âœ… EditQuestionModal - Full-featured question editing modal with validation and success feedback

**Environment System:**
- âœ… Dual dev/prod table architecture
- âœ… Environment manager singleton (`src/config/environment.ts`)
- âœ… React Context for environment state (`EnvironmentContext`)
- âœ… AsyncStorage persistence
- âœ… All services are environment-aware
- âœ… Automatic table name switching based on environment

**Database Integration:**
- âœ… Production tables: `categories`, `questions`, `game_sessions`, `game_answers`, `category_stats`
- âœ… Development tables: `categories_dev`, `questions_dev`, `game_sessions_dev`, `game_answers_dev`, `category_stats_dev`
- âœ… Shared tables: `profiles`, `user_stats`
- âœ… Complete RLS policies for both environments
- âœ… Environment-aware service queries

**Question Management:**
- âœ… CSV import script (`scripts/import-questions-from-csv.js`)
- âœ… Duplicate detection
- âœ… Category auto-creation
- âœ… Question admin service (CRUD operations)
- âœ… Question review UI with filtering
- âœ… Edit question modal with full validation and success feedback
- âœ… Activate/deactivate questions
- âœ… Delete questions

**Migration System:**
- âœ… Migration service (`migration.service.ts`)
- âœ… Single question migration
- âœ… Category migration
- âœ… Flag questions for production
- âœ… Batch migration of flagged questions
- âœ… Duplicate detection during migration
- âœ… Category mapping by name

**Dev Mode Features:**
- âœ… In-game question actions (Flag, Review, Edit, Delete)
- âœ… Action required before proceeding to next question
- âœ… Navigation to QuestionReviewScreen from gameplay
- âœ… Environment switcher UI in HomeScreen
- âœ… Role-based access control (dev tools only visible to admin users)
- âœ… Dev tools section with content management links (hidden from non-admins)
- âœ… Quality metrics and completeness scoring
- âœ… Migration readiness dashboard with batch migration

### âš ï¸ Incomplete Features (Placeholders)

1. **Leaderboard:**
   - Button exists in HomeScreen
   - No implementation
   - **Location**: `src/screens/HomeScreen.tsx:52`
   - **Note**: Requires design decisions (global vs per-category, time period, etc.)

3. **My Stats:**
   - Button exists in HomeScreen
   - No implementation (service exists: `userStatsService`)
   - **Location**: `src/screens/HomeScreen.tsx:59`
   - **Note**: Service layer ready, just needs UI

### ğŸ“‹ Setup Requirements (User Must Do)

1. **Run Database Migration:**
   ```sql
   -- In Supabase SQL Editor:
   -- Run: database/create-dev-tables.sql
   ```

2. **Set Up Service Role Key:**
   ```env
   # Create .env file with:
   SUPABASE_URL=https://wdprqnjcfzuamzhtgiog.supabase.co
   SUPABASE_SERVICE_KEY=<get from Supabase Dashboard â†’ Settings â†’ API>
   ```

3. **Import Questions:**
   ```bash
   npm run import:questions bible-questions-characters.csv
   ```

## Project Structure

```
src/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ environment.ts              # Environment manager singleton
â”œâ”€â”€ contexts/
â”‚   â”œâ”€â”€ AuthContext.tsx             # Authentication state/logic (âœ… tested)
â”‚   â””â”€â”€ EnvironmentContext.tsx      # Environment switching state
â”œâ”€â”€ navigation/
â”‚   â”œâ”€â”€ RootNavigator.tsx           # Auth vs Main navigator (âœ… tested)
â”‚   â””â”€â”€ MainNavigator.tsx           # Main app screens
â”œâ”€â”€ screens/
â”‚   â”œâ”€â”€ LoginScreen.tsx             # Signup/Login (âœ… tested)
â”‚   â”œâ”€â”€ SignupScreen.tsx            # Signup form (âœ… tested)
â”‚   â”œâ”€â”€ HomeScreen.tsx              # Main menu with env switcher
â”‚   â”œâ”€â”€ DifficultyScreen.tsx        # Difficulty selection
â”‚   â”œâ”€â”€ GameScreen.tsx              # Gameplay (with dev mode)
â”‚   â”œâ”€â”€ ResultsScreen.tsx           # Score results
â”‚   â”œâ”€â”€ QuestionReviewScreen.tsx    # Question list and actions
â”‚   â”œâ”€â”€ QuestionCreateScreen.tsx    # Manual question creation
â”‚   â”œâ”€â”€ BatchReviewScreen.tsx       # Card-based review workflow
â”‚   â””â”€â”€ QuestionStatsScreen.tsx     # Statistics and quality metrics
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ auth.service.ts             # Authentication (âœ… tested)
â”‚   â”œâ”€â”€ question.service.ts         # Question queries (env-aware) âŒ needs tests
â”‚   â”œâ”€â”€ game.service.ts             # Game sessions (env-aware) âŒ needs tests
â”‚   â”œâ”€â”€ user-stats.service.ts       # User stats (env-aware) âŒ needs tests
â”‚   â”œâ”€â”€ migration.service.ts        # Devâ†’Prod migration âŒ needs tests
â”‚   â””â”€â”€ question-admin.service.ts   # Question CRUD âŒ needs tests
â””â”€â”€ types/
    â””â”€â”€ database.ts                 # TypeScript types

database/
â”œâ”€â”€ schema.sql                      # Production schema
â”œâ”€â”€ seed.sql                        # Sample data
â”œâ”€â”€ create-dev-tables.sql           # Dev tables (RUN THIS!)
â”œâ”€â”€ relax-dev-rls-policies.sql      # Optional RLS relaxation
â”œâ”€â”€ 002_enhance_categories.sql      # Category enhancements
â”œâ”€â”€ 003_enhance_questions.sql       # Question enhancements
â””â”€â”€ add-migration-status.sql        # Migration tracking

scripts/
â””â”€â”€ import-questions-from-csv.js    # CSV import utility âŒ needs tests

__tests__/
â”œâ”€â”€ auth.integration.test.ts        # Auth integration tests âœ…
â””â”€â”€ services/
    â””â”€â”€ auth.service.test.ts        # Auth service tests âœ…
```

## Key Architectural Decisions

### Environment Manager Pattern
- **Singleton pattern** for global environment state
- **AsyncStorage persistence** survives app restarts
- **Observer pattern** for environment change listeners
- **Automatic table name resolution** based on current environment

### Service Layer Design
All services use `environmentManager.getTables()` instead of hardcoded table names:

```typescript
// Example from question.service.ts
const tables = environmentManager.getTables();
const { data } = await supabase
  .from(tables.questions) // Resolves to 'questions' or 'questions_dev'
  .select('*');
```

### React Context for UI State
- `EnvironmentContext` wraps entire app
- Provides `useEnvironment()` hook
- Components can reactively respond to environment changes

### Migration Safety
- Migrations are **one-way** (dev â†’ prod)
- **Duplicate detection** prevents overwriting
- **Category mapping by name** (not ID)
- Questions require category to exist in prod

## Development Workflow

```
1. Create/Import Content in Dev
   â†“
2. Review & Test (QuestionReviewScreen)
   â†“
3. Flag Approved Questions
   â†“
4. Migrate to Production (batch or individual)
   â†“
5. Test in Production Mode
```

## Environment Variables

Required in `.env`:
```env
SUPABASE_URL=https://wdprqnjcfzuamzhtgiog.supabase.co
SUPABASE_SERVICE_KEY=<your-service-role-key>  # For CSV imports
SUPABASE_ANON_KEY=<your-anon-key>              # Optional (already in code)
```

## Available npm Scripts

```bash
npm start                           # Start Expo dev server
npm run ios                         # iOS simulator
npm run android                     # Android emulator
npm run web                         # Web browser
npm run import:questions <file>     # Import CSV
npm test                            # Run tests
npm run test:watch                  # Watch mode tests
npm run test:coverage               # Coverage report
```

## Documentation Files

- **README.md** - Complete project documentation
- **DEV_PROD_MIGRATION_GUIDE.md** - Environment system guide
- **QUESTION_IMPORT_GUIDE.md** - CSV import instructions
- **QUICK_START_IMPORT.md** - Quick reference

## Database Tables

### Production Tables
- `categories` - Question categories
- `questions` - Trivia questions
- `game_sessions` - Game play sessions
- `game_answers` - Individual answers
- `category_stats` - Per-category user stats
- `user_stats` - Overall user statistics
- `profiles` - User profiles (managed by Supabase Auth)

### Development Tables (mirror production)
- `categories_dev`
- `questions_dev`
- `game_sessions_dev`
- `game_answers_dev`
- `category_stats_dev`

### Field: `ready_for_prod` (questions_dev only)
Boolean flag to mark questions for batch migration.

## Common Tasks

### Switch Environment Programmatically
```typescript
import { environmentManager } from './src/config/environment';
await environmentManager.setEnvironment('development'); // or 'production'
```

### Import Questions from CSV
```bash
npm run import:questions bible-questions-characters.csv
```

### Migrate Single Question
```typescript
import { migrationService } from './src/services/migration.service';
await migrationService.migrateQuestion(questionId);
```

### Migrate All Flagged Questions
```typescript
await migrationService.batchMigrateFlaggedQuestions();
```

### Get Question Statistics
```typescript
import { questionAdminService } from './src/services/question-admin.service';
const { stats } = await questionAdminService.getQuestionStats();
// Returns: { total, active, inactive, byDifficulty, byCategory }
```

## Known Issues

1. **Dependency Conflict:**
   - `@testing-library/react-hooks@8.0.1` has peer dependency conflict
   - Requires `npm install --legacy-peer-deps`
   - Non-critical for app functionality

2. **Missing UI Components:**
   - Leaderboard is placeholder
   - My Stats is placeholder

## Development Roadmap

### Phase 1: Critical Features & Core Testing (Weeks 1-2)
**Goal**: Complete essential features and establish testing foundation

1. **Core Service Tests** ğŸ§ª TESTING
   - question.service.ts - Question fetching, category logic
   - game.service.ts - Session creation, answer recording
   - user-stats.service.ts - Stats calculation, updates
   - question-admin.service.ts - CRUD operations
   - migration.service.ts - Devâ†’Prod migration, duplicate detection

3. **Security Testing** ğŸ”’ SECURITY
   - RLS policy verification (dev vs prod isolation)
   - User data access boundaries
   - Service role key security audit
   - Dev mode feature gating
   - SQL injection vulnerability check

### Phase 2: Feature Completion & Integration Testing (Weeks 3-4)
**Goal**: Complete placeholder features and test workflows

4. **My Stats Screen** ğŸ“Š
   - Overall performance metrics
   - Category breakdown
   - Difficulty progression
   - Historical trends
   - Service layer already exists

5. **Leaderboard Screen** ğŸ†
   - Design decisions needed:
     - Global vs per-category
     - Time period filters (all-time, weekly, monthly)
     - Privacy settings
   - Database schema updates
   - Real-time vs cached rankings

6. **Integration Tests** ğŸ§ª TESTING
   - Complete game flow (difficulty â†’ game â†’ results)
   - Question management workflow (create â†’ review â†’ flag â†’ migrate)
   - Environment switching persistence
   - CSV import end-to-end
   - Migration workflow validation

### Phase 3: Enhanced Features & UI Testing (Weeks 5-6)
**Goal**: Add engagement features and comprehensive UI tests

7. **UI/Component Tests** ğŸ§ª TESTING
   - HomeScreen - Navigation, environment switching
   - GameScreen - Timer, scoring, answer selection
   - QuestionReviewScreen - Filtering, actions
   - BatchReviewScreen - Card navigation, approval workflow
   - QuestionStatsScreen - Stats display, migration actions

8. **Question Type Enhancements**
   - True/false question support (schema ready)
   - Fill-in-the-blank support (schema ready)
   - Question type switching in game UI
   - Validation for each type

9. **Question Analytics**
   - Track incorrect answers per question
   - Difficulty adjustment recommendations
   - Popular questions tracking
   - Category performance insights

### Phase 4: Polish & Production Prep (Week 7+)
**Goal**: Performance, UX improvements, production readiness

10. **Category Selection in Game Flow**
    - Category picker before difficulty
    - "All Categories" option
    - Category filtering logic

11. **Performance Optimization**
    - Question pagination for large datasets
    - Image optimization (if added)
    - Bundle size analysis
    - Database query optimization

12. **UX Enhancements** (Lower Priority)
    - Sound effects for correct/incorrect answers
    - Animations and transitions
    - Achievements system
    - Social sharing
    - Haptic feedback

13. **Production Deployment Checklist**
    - All critical tests passing
    - Security audit complete
    - RLS policies verified
    - Error tracking setup (e.g., Sentry)
    - Analytics setup
    - Performance benchmarks met
    - Production data migration plan
    - Rollback strategy

### Testing Priority Matrix

| Test Category | Priority | Estimated Time | Dependencies |
|--------------|----------|----------------|--------------|
| Migration service tests | ğŸ”´ Critical | 4-6 hours | None |
| Question service tests | ğŸ”´ Critical | 3-4 hours | None |
| Game service tests | ğŸ”´ Critical | 3-4 hours | None |
| RLS policy tests | ğŸ”´ Critical | 6-8 hours | Database access |
| Integration: Game flow | ğŸŸ¡ High | 4-5 hours | Core service tests |
| Integration: Migration | ğŸŸ¡ High | 3-4 hours | Migration tests |
| UI: Game screens | ğŸŸ¡ High | 6-8 hours | None |
| UI: Question screens | ğŸŸ¢ Medium | 6-8 hours | None |
| User stats service | ğŸŸ¢ Medium | 2-3 hours | None |
| CSV import tests | ğŸŸ¢ Medium | 2-3 hours | None |

### Feature Priority Matrix

| Feature | Priority | Estimated Time | Dependencies |
|---------|----------|----------------|--------------|
| My Stats Screen | ğŸŸ¡ High | 4-6 hours | User stats tests |
| Leaderboard | ğŸŸ¡ High | 8-12 hours | Design decisions, DB schema |
| Question Analytics | ğŸŸ¢ Medium | 6-8 hours | Game service updates |
| Category Selection | ğŸŸ¢ Medium | 3-4 hours | None |
| Question Type Support | ğŸŸ¢ Medium | 6-8 hours | UI updates per type |
| Sound Effects | ğŸ”µ Low | 2-3 hours | Asset creation |
| Achievements | ğŸ”µ Low | 12-16 hours | DB schema, UI design |

### Immediate Next Steps (This Week)

1. **Write Migration Service Tests** (Day 1-2)
   - Test question migration
   - Test category migration
   - Test duplicate detection
   - Test error handling

3. **Write Question Service Tests** (Day 3-4)
   - Test question fetching by difficulty
   - Test category retrieval
   - Test environment-aware table switching

4. **Security Audit: RLS Policies** (Day 4-5)
   - Manual testing of policy enforcement
   - Automated tests for data isolation
   - Documentation of security boundaries

## Testing Strategy

### Current Test Coverage
- âœ… **Auth Tests**: Comprehensive suite for auth service, context, and screens
- âŒ **Core Services**: question.service, game.service, user-stats.service (no tests)
- âŒ **Admin Services**: question-admin.service, migration.service (no tests)
- âŒ **Game Screens**: Home, Difficulty, Game, Results (no tests)
- âŒ **Question Screens**: QuestionReview, QuestionCreate, BatchReview, QuestionStats (no tests)
- âŒ **Integration Tests**: No end-to-end game flow or migration workflow tests
- âŒ **Security Tests**: No RLS policy testing, no boundary testing

### Testing Gaps Identified

**Critical Gaps:**
1. **Migration Service Testing** - No validation that devâ†’prod migration works correctly
2. **Question Service Testing** - No tests for question fetching, category logic
3. **Game Flow Testing** - No integration tests for complete game sessions
4. **RLS Policy Testing** - No verification that security policies work as intended
5. **Environment Switching** - No tests for table switching logic

**Medium Priority Gaps:**
1. UI component tests for all game screens
2. User stats service testing
3. CSV import script testing
4. Question admin service testing

**Security Testing Requirements:**
1. RLS policies enforce proper data isolation (dev vs prod)
2. Users can only access their own game data
3. Service role key is never exposed to client
4. Migration preserves data integrity
5. Dev mode features are properly gated

## Security Considerations

- **Service Role Key**: Only for import scripts, not in app code
- **RLS Policies**: Enabled on all tables (prod and dev)
- **Dev Tables**: Same security as prod tables
- **Migration**: Only copies data, doesn't expose service key
- **Auth**: Managed by Supabase Auth (secure by default)

## Performance Considerations

- **AsyncStorage**: Environment preference cached
- **Service Layer**: Direct Supabase queries (no unnecessary abstraction)
- **Question Shuffling**: Client-side (reduces server load)
- **Pagination**: Not yet implemented (could be added for large question sets)

## Code Quality

- **TypeScript**: Strict mode enabled
- **Type Safety**: All database types in `src/types/database.ts`
- **Error Handling**: Services return `{ data, error }` pattern
- **Consistent Patterns**: All services follow same structure
- **No Hardcoded Values**: Environment-aware table names

## Git Workflow Recommendations

1. **Never commit `.env`** (already in .gitignore)
2. **Commit dev table SQL** so others can set up
3. **Don't commit CSV files** with sensitive data
4. **Use feature branches** for new screens/features
5. **Test migration** before committing to main

## Resources

- [Supabase Docs](https://supabase.com/docs)
- [React Navigation Docs](https://reactnavigation.org/)
- [React Native Docs](https://reactnative.dev/)
- [Expo Docs](https://docs.expo.dev/)
